---
export const prerender = false;
import AuthLayout from '../layouts/AuthLayout.astro';
import { ResetPasswordForm } from '../components/react/ResetPasswordForm';
import Logo from '../components/astro/Logo.astro';
import { actions } from 'astro:actions';
import type { ServerActionResult } from '../types';
import { updatePassword as updatePasswordAction } from '../actions/auth';

// This page is accessible after clicking the password reset link from email
// User must be in recovery session to access this page
const user = Astro.locals.user;

// If no user in session (not in recovery mode), redirect to forgot password
if (!user) {
    return Astro.redirect('/forgot-password');
}

type ResetPasswordActionResponse = {
    success?: boolean;
    message?: string;
};

const actionResult = Astro.getActionResult(
    updatePasswordAction as Parameters<typeof Astro.getActionResult>[0]
) as ServerActionResult<ResetPasswordActionResponse>;
const resetError = actionResult?.error?.message;
const resetSuccess = Boolean(actionResult?.data?.success);
const resetMessage = actionResult?.data?.message;
---

<AuthLayout title="Nowe hasło">
    <div class="text-center mb-8">
        <div class="inline-block mb-4">
            <Logo />
        </div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Ustaw nowe hasło</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">Wprowadź nowe hasło do swojego konta</p>
    </div>

    <ResetPasswordForm
        action={actions.auth.updatePassword}
        error={resetError}
        success={resetSuccess}
        message={resetMessage}
    />
</AuthLayout>
